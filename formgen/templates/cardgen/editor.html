{% extends "base.html" %}
{% block title %}Card Template Editor - {{ template.name }}{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-100">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ template.name }}</h1>
                    <p class="text-gray-600 mt-1">Visual Card Template Editor</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="saveTemplate()" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        Save Template
                    </button>
                    <button onclick="toggleJsonView()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        JSON View
                    </button>
                    <a href="{% url 'cardgen_templates' template.organisation.id %}" 
                       class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                        Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="h-screen flex flex-col">
        <!-- Visual Editor -->
        <div id="visualEditor" class="flex-1 flex overflow-hidden">
            <!-- Component Tree & AI Chat (Left Panel) -->
            <div class="w-80 bg-white border-r border-gray-200 flex flex-col min-w-0">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-4" aria-label="Tabs">
                        <button onclick="switchTab('component-tree')" 
                                id="tab-component-tree" 
                                class="tab-button py-4 px-1 border-b-2 font-medium text-sm transition-colors border-blue-500 text-blue-600">
                            Component Tree
                        </button>
                        <button onclick="switchTab('ai-chat')" 
                                id="tab-ai-chat" 
                                class="tab-button py-4 px-1 border-b-2 font-medium text-sm transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            AI Chat
                        </button>
                    </nav>
                </div>

                <!-- Component Tree Tab Content -->
                <div id="tab-content-component-tree" class="flex-1 overflow-hidden flex flex-col">
                    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-900">Component Tree</h2>
                        <div class="flex items-center space-x-2">
                            <button onclick="toggleTreeView()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="Toggle tree view">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                </svg>
                            </button>
                            <button onclick="toggleComponentPalette()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded" title="Add components">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden flex flex-col">
                        <!-- Tree Controls -->
                        <div class="p-2 border-b border-gray-100 bg-gray-50 flex items-center justify-between text-xs text-gray-600">
                            <span id="treeStats">0 components</span>
                            <div class="flex items-center space-x-2">
                                <button onclick="expandAllComponents()" class="text-blue-600 hover:text-blue-800">Expand All</button>
                                <button onclick="collapseAllComponents()" class="text-blue-600 hover:text-blue-800">Collapse All</button>
                            </div>
                        </div>
                        <!-- Tree Container with horizontal scroll -->
                        <div class="flex-1 overflow-auto" id="treeContainer">
                            <div id="componentTree" class="min-w-max p-4">
                                <!-- Tree will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Chat Tab Content -->
                <div id="tab-content-ai-chat" class="flex-1 overflow-hidden flex flex-col hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">AI Assistant</h2>
                        <p class="text-sm text-gray-600 mt-1">Chat with GPT to get help with your card template</p>
                    </div>
                    
                    <!-- Chat Messages Area -->
                    <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatMessages">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                                <p class="text-sm text-gray-700">Hello! I'm your AI assistant. I can help you with:</p>
                                <ul class="text-xs text-gray-600 mt-2 space-y-1">
                                    <li>• Component structure suggestions</li>
                                    <li>• CSS styling help</li>
                                    <li>• Template optimization</li>
                                    <li>• Code generation</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input Area -->
                    <div class="border-t border-gray-200 p-4">
                        <div class="flex space-x-2">
                            <input type="text" 
                                   id="chatInput" 
                                   placeholder="Ask me anything about your template..."
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                   onkeypress="handleChatKeyPress(event)">
                            <button onclick="sendChatMessage()" 
                                    id="sendChatButton"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="mt-2 text-xs text-gray-500">
                            Press Enter to send, or click the send button
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resizable Handle -->
            <div class="w-1 bg-gray-200 hover:bg-gray-300 cursor-col-resize" id="resizeHandle"></div>

            <!-- Live Preview (Center Panel) -->
            <div class="flex-1 bg-white flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Live Preview</h2>
                </div>
                <div class="flex-1 overflow-auto p-4">
                    <div id="livePreview" class="min-h-full border border-gray-200 rounded p-4 bg-gray-50">
                        <!-- Live HTML preview will appear here -->
                    </div>
                </div>
            </div>

            <!-- Resizable Handle -->
            <div class="w-1 bg-gray-200 hover:bg-gray-300 cursor-col-resize" id="resizeHandle2"></div>

            <!-- Properties Panel (Right Panel) -->
            <div class="w-80 bg-white border-l border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Properties</h2>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="propertiesPanel">
                        <p class="text-gray-500 text-center">Select a component to edit properties</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Component Palette Popup -->
        <div id="componentPalette" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] mx-4 flex flex-col">
                <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Component Palette</h2>
                    <button onclick="toggleComponentPalette()" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- HTML Elements -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">HTML Elements</h3>
                            <div class="space-y-2">
                                <div class="component-item" data-tag="div" draggable="true">
                                    <span class="text-blue-600">📦</span> Container (div)
                                </div>
                                <div class="component-item" data-tag="p" draggable="true">
                                    <span class="text-green-600">📝</span> Text (p)
                                </div>
                                <div class="component-item" data-tag="h1" draggable="true">
                                    <span class="text-purple-600">📰</span> Heading 1
                                </div>
                                <div class="component-item" data-tag="h2" draggable="true">
                                    <span class="text-purple-600">📰</span> Heading 2
                                </div>
                                <div class="component-item" data-tag="h3" draggable="true">
                                    <span class="text-purple-600">📰</span> Heading 3
                                </div>
                                <div class="component-item" data-tag="span" draggable="true">
                                    <span class="text-gray-600">🏷️</span> Span
                                </div>
                            </div>
                        </div>
                        
                        <!-- Interactive Components -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Interactive Components</h3>
                            <div class="space-y-2">
                                <div class="component-item" data-tag="Itext" draggable="true">
                                    <span class="text-orange-600">📝</span> Text Input
                                </div>
                                <div class="component-item" data-tag="IBool" draggable="true">
                                    <span class="text-red-600">☑️</span> Checkbox
                                </div>
                                <div class="component-item" data-tag="IChoice" draggable="true">
                                    <span class="text-indigo-600">📋</span> Dropdown
                                </div>
                                <div class="component-item" data-tag="IToggle" draggable="true">
                                    <span class="text-pink-600">🔄</span> Toggle Group
                                </div>
                                <div class="component-item" data-tag="Imultiline" draggable="true">
                                    <span class="text-teal-600">📄</span> Textarea
                                </div>
                                <div class="component-item" data-tag="Ibutton" draggable="true">
                                    <span class="text-yellow-600">🔘</span> Button
                                </div>
                                <div class="component-item" data-tag="I_V_Button" draggable="true">
                                    <span class="text-yellow-600">🔘</span> Advanced Button
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-200 bg-gray-50">
                    <p class="text-sm text-gray-600 text-center">
                        Drag components to the Component Tree to add them to your template
                    </p>
                </div>
            </div>
        </div>

        <!-- JSON Editor (Hidden by default) -->
        <div id="jsonEditor" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- JSON Editor -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-900">Template JSON</h2>
                            <div class="flex space-x-2">
                                <button onclick="validateJson()" 
                                        class="px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600">
                                    Validate
                                </button>
                                <button onclick="formatJson()" 
                                        class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
                                    Format
                                </button>
                            </div>
                        </div>
                        
                        <textarea id="templateJson" 
                                  class="w-full h-96 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="Enter your card template JSON here..."></textarea>
                        
                        <div class="mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Global Variables</h3>
                            <textarea id="globalVars" 
                                      class="w-full h-32 border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                      placeholder="Enter global variables JSON here..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Preview and Documentation -->
                <div class="space-y-6">
                    <!-- Preview -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Preview</h2>
                            <div id="preview" class="border border-gray-200 rounded p-4 min-h-64 bg-gray-50">
                                <p class="text-gray-500 text-center">JSON preview will appear here</p>
                            </div>
                        </div>
                    </div>

                    <!-- Component Documentation -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold text-gray-900 mb-4">Component Reference</h2>
                            <div class="space-y-4 text-sm">
                                <div>
                                    <h3 class="font-medium text-gray-900">HTML Elements</h3>
                                    <p class="text-gray-600">div, p, span, h1-h6, img, a, button</p>
                                    <code class="block mt-1 p-2 bg-gray-100 rounded text-xs">
                                        {"tag": "div", "class": "flex flex-col", "children": [...]}
                                    </code>
                                </div>
                                
                                <div>
                                    <h3 class="font-medium text-gray-900">Interactive Components</h3>
                                    <p class="text-gray-600">Itext, IBool, IChoice, IToggle, Imultiline, Ibutton, I_V_Button</p>
                                    <code class="block mt-1 p-2 bg-gray-100 rounded text-xs">
                                        {"tag": "Itext", "type": "Editable", "title": "Label", "value": "", "var": "variable_name"}
                                    </code>
                                </div>
                                
                                <div>
                                    <h3 class="font-medium text-gray-900">Component Properties</h3>
                                    <ul class="text-gray-600 space-y-1">
                                        <li><strong>tag:</strong> Component type</li>
                                        <li><strong>type:</strong> "Editable" or "display"</li>
                                        <li><strong>title:</strong> Component label</li>
                                        <li><strong>value:</strong> Component value</li>
                                        <li><strong>var:</strong> Variable name for resolution</li>
                                        <li><strong>class:</strong> CSS classes</li>
                                        <li><strong>children:</strong> Child components array</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let templateData = JSON.parse('{{ template_data_json|escapejs }}');
let globalVars = JSON.parse('{{ global_vars_json|escapejs }}');
let selectedComponent = null;
let componentCounter = 0;

// Component definitions with default properties
const componentDefaults = {
    'div': { tag: 'div', class: 'flex flex-col gap-2 p-4', children: [] },
    'p': { tag: 'p', value: 'Text content', class: 'text-gray-700' },
    'h1': { tag: 'h1', value: 'Heading 1', class: 'text-3xl font-bold' },
    'h2': { tag: 'h2', value: 'Heading 2', class: 'text-2xl font-bold' },
    'h3': { tag: 'h3', value: 'Heading 3', class: 'text-xl font-bold' },
    'span': { tag: 'span', value: 'Span text', class: 'text-gray-600' },
    'Itext': { tag: 'Itext', type: 'Editable', title: 'Text Input', value: '', class: 'w-full p-2 border rounded' },
    'IBool': { tag: 'IBool', type: 'Editable', title: 'Checkbox', value: false, class: 'w-4 h-4' },
    'IChoice': { tag: 'IChoice', type: 'Editable', title: 'Dropdown', value: '', choices: ['Option 1', 'Option 2'], class: 'w-full p-2 border rounded' },
    'IToggle': { tag: 'IToggle', type: 'Editable', title: 'Toggle Group', value: '', options: ['Option 1', 'Option 2'], class: 'flex gap-2' },
    'Imultiline': { tag: 'Imultiline', type: 'Editable', title: 'Textarea', value: '', class: 'w-full p-2 border rounded' },
    'Ibutton': { tag: 'Ibutton', type: 'Editable', title: 'Button', value: 'Click me', class: 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600' },
    'I_V_Button': { tag: 'I_V_Button', type: 'Editable', title: 'Advanced Button', value: 'Click me', variant: 'default', size: 'default', class: 'px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600' }
};

// Initialize the editor
document.addEventListener('DOMContentLoaded', function() {
    initializeVisualEditor();
    setupDragAndDrop();
    setupComponentDragAndDrop();
    setupResizing();
    renderComponentTree();
    
    // Initialize the textareas with the properly loaded data
    document.getElementById('templateJson').value = JSON.stringify(templateData, null, 2);
    document.getElementById('globalVars').value = JSON.stringify(globalVars, null, 2);
    
    updateLivePreview();
    
    // Auto-update preview on JSON changes
    document.getElementById('templateJson').addEventListener('input', function() {
        updatePreview();
    });
    
    document.getElementById('globalVars').addEventListener('input', function() {
        updatePreview();
    });
});

function initializeVisualEditor() {
    // Ensure templateData is an array
    if (!Array.isArray(templateData)) {
        templateData = [];
    }
    
    // Add unique IDs to all components
    addComponentIds(templateData);
}

function addComponentIds(components) {
    components.forEach((component, index) => {
        if (!component.id) {
            component.id = `comp_${componentCounter++}`;
        }
        if (component.children && Array.isArray(component.children)) {
            addComponentIds(component.children);
        }
    });
}

function setupDragAndDrop() {
    // Make component items draggable (both in popup and any future instances)
    function setupDraggableItems() {
        document.querySelectorAll('.component-item').forEach(item => {
            if (!item.hasAttribute('data-drag-setup')) {
                item.setAttribute('data-drag-setup', 'true');
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.tag);
                });
            }
        });
    }
    
    // Initial setup
    setupDraggableItems();
    
    // Re-setup when popup is shown (in case items are recreated)
    const palette = document.getElementById('componentPalette');
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (!palette.classList.contains('hidden')) {
                    setupDraggableItems();
                }
            }
        });
    });
    observer.observe(palette, { attributes: true });
    
    // Make component tree droppable
    const componentTree = document.getElementById('componentTree');
    componentTree.addEventListener('dragover', function(e) {
        e.preventDefault();
    });
    
    componentTree.addEventListener('drop', function(e) {
        e.preventDefault();
        const tag = e.dataTransfer.getData('text/plain');
        addComponentToRoot(tag);
        // Close the palette after dropping
        toggleComponentPalette();
    });
}

function setupResizing() {
    const leftPanel = document.querySelector('.w-80.border-r');
    const rightPanel = document.querySelector('.w-80.border-l');
    const centerPanel = document.querySelector('.flex-1.bg-white');
    const resizeHandle = document.getElementById('resizeHandle');
    const resizeHandle2 = document.getElementById('resizeHandle2');
    
    let isResizing = false;
    let startX = 0;
    let startWidth = 0;
    
    // Left resize handle
    resizeHandle.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startWidth = leftPanel.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });
    
    // Right resize handle
    resizeHandle2.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startWidth = rightPanel.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const newWidth = Math.max(200, Math.min(600, startWidth + deltaX));
        
        if (resizeHandle.matches(':hover') || document.body.style.cursor === 'col-resize') {
            leftPanel.style.width = newWidth + 'px';
        } else if (resizeHandle2.matches(':hover') || document.body.style.cursor === 'col-resize') {
            rightPanel.style.width = newWidth + 'px';
        }
    });
    
    document.addEventListener('mouseup', function() {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
    });
}

function toggleComponentPalette() {
    const palette = document.getElementById('componentPalette');
    palette.classList.toggle('hidden');
    palette.classList.toggle('flex');
}

function addComponentToRoot(tag) {
    const newComponent = JSON.parse(JSON.stringify(componentDefaults[tag]));
    newComponent.id = `comp_${componentCounter++}`;
    templateData.push(newComponent);
    renderComponentTree();
    updateLivePreview();
}

function addComponentToParent(parentId, tag) {
    const newComponent = JSON.parse(JSON.stringify(componentDefaults[tag]));
    newComponent.id = `comp_${componentCounter++}`;
    
    const parent = findComponentById(templateData, parentId);
    if (parent) {
        if (!parent.children) {
            parent.children = [];
        }
        parent.children.push(newComponent);
        renderComponentTree();
        updateLivePreview();
    }
}

function findComponentById(components, id) {
    for (let component of components) {
        if (component.id === id) {
            return component;
        }
        if (component.children) {
            const found = findComponentById(component.children, id);
            if (found) return found;
        }
    }
    return null;
}

function renderComponentTree() {
    const treeContainer = document.getElementById('componentTree');
    
    if (templateData.length === 0) {
        treeContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>No components yet</p>
                <p class="text-sm">Click the ? icon to open the component palette</p>
            </div>
        `;
        updateTreeStats();
        return;
    }
    
    treeContainer.innerHTML = templateData.map(component => renderComponentNode(component)).join('');
    updateTreeStats();
}

function updateTreeStats() {
    const stats = document.getElementById('treeStats');
    const count = countComponents(templateData);
    stats.textContent = `${count} component${count !== 1 ? 's' : ''}`;
}

function countComponents(components) {
    let count = components.length;
    components.forEach(component => {
        if (component.children && component.children.length > 0) {
            count += countComponents(component.children);
        }
    });
    return count;
}

function toggleComponentExpansion(componentId) {
    const component = findComponentById(templateData, componentId);
    if (component) {
        component.expanded = !component.expanded;
        renderComponentTree();
    }
}

function expandAllComponents() {
    setAllComponentsExpanded(templateData, true);
    renderComponentTree();
}

function collapseAllComponents() {
    setAllComponentsExpanded(templateData, false);
    renderComponentTree();
}

function setAllComponentsExpanded(components, expanded) {
    components.forEach(component => {
        component.expanded = expanded;
        if (component.children && component.children.length > 0) {
            setAllComponentsExpanded(component.children, expanded);
        }
    });
}

function toggleTreeView() {
    const treeContainer = document.getElementById('treeContainer');
    const isCompact = treeContainer.classList.contains('compact-view');
    
    if (isCompact) {
        treeContainer.classList.remove('compact-view');
        // Restore normal view
        document.querySelectorAll('.component-node').forEach(node => {
            node.style.minWidth = '200px';
            node.style.padding = '0.5rem';
        });
    } else {
        treeContainer.classList.add('compact-view');
        // Make compact view
        document.querySelectorAll('.component-node').forEach(node => {
            node.style.minWidth = '150px';
            node.style.padding = '0.25rem';
        });
    }
}

function renderComponentNode(component, level = 0) {
    const hasChildren = component.children && component.children.length > 0;
    const isInteractive = component.tag.startsWith('I');
    const isExpanded = component.expanded !== false; // Default to expanded
    
    // Create indentation with visual tree lines
    const indentWidth = level * 20;
    const treeLines = level > 0 ? createTreeLines(level) : '';
    
    let html = `
        <div class="component-node border border-gray-200 rounded p-2 mb-1 ${selectedComponent === component.id ? 'bg-blue-50 border-blue-300' : 'bg-white hover:bg-gray-50'} draggable-component" 
             data-component-id="${component.id}" 
             draggable="true"
             style="margin-left: ${indentWidth}px; min-width: 200px;">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-1 flex-1 min-w-0">
                    ${treeLines}
                    ${hasChildren ? `
                        <button onclick="toggleComponentExpansion('${component.id}')" 
                                class="expand-btn p-1 text-gray-400 hover:text-gray-600 transition-colors" 
                                title="${isExpanded ? 'Collapse' : 'Expand'}">
                            <svg class="w-3 h-3 transform transition-transform ${isExpanded ? 'rotate-90' : ''}" 
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    ` : '<div class="w-5"></div>'}
                    <div class="drag-handle cursor-move text-gray-400 hover:text-gray-600 p-1" 
                         onmousedown="event.stopPropagation()" 
                         title="Drag to reorder">
                        <svg width="10" height="10" viewBox="0 0 12 12" fill="currentColor">
                            <circle cx="2" cy="2" r="1"/>
                            <circle cx="6" cy="2" r="1"/>
                            <circle cx="10" cy="2" r="1"/>
                            <circle cx="2" cy="6" r="1"/>
                            <circle cx="6" cy="6" r="1"/>
                            <circle cx="10" cy="6" r="1"/>
                            <circle cx="2" cy="10" r="1"/>
                            <circle cx="6" cy="10" r="1"/>
                            <circle cx="10" cy="10" r="1"/>
                        </svg>
                    </div>
                    <span class="text-xs font-medium text-gray-900">${getComponentIcon(component.tag)} ${component.tag}</span>
                    ${component.title ? `<span class="text-xs text-gray-500 truncate ml-1">"${component.title}"</span>` : ''}
                </div>
                <div class="flex items-center space-x-1 ml-2">
                    <button onclick="selectComponent('${component.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">Edit</button>
                    <button onclick="deleteComponent('${component.id}')" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">×</button>
                </div>
            </div>
            ${component.value && !hasChildren ? `<div class="text-xs text-gray-400 mt-1 truncate ml-8">"${component.value}"</div>` : ''}
    `;
    
    if (hasChildren && isExpanded) {
        html += '<div class="children-container mt-1">';
        html += component.children.map(child => renderComponentNode(child, level + 1)).join('');
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function createTreeLines(level) {
    let lines = '';
    for (let i = 0; i < level; i++) {
        lines += `<div class="tree-line w-5 h-px bg-gray-300"></div>`;
    }
    return lines;
}

function getComponentIcon(tag) {
    const icons = {
        'div': '📦', 'p': '📝', 'h1': '📰', 'h2': '📰', 'h3': '📰', 'span': '🏷️',
        'Itext': '📝', 'IBool': '☑️', 'IChoice': '📋', 'IToggle': '🔄', 
        'Imultiline': '📄', 'Ibutton': '🔘', 'I_V_Button': '🔘'
    };
    return icons[tag] || '❓';
}

function selectComponent(id) {
    selectedComponent = id;
    renderComponentTree();
    renderPropertiesPanel();
}

function deleteComponent(id) {
    if (confirm('Are you sure you want to delete this component?')) {
        // Remove component from templateData (including nested components)
        templateData = removeComponentById(templateData, id);
        
        // Clear selection if the deleted component was selected
        if (selectedComponent === id) {
            selectedComponent = null;
            renderPropertiesPanel();
        }
        
        // Refresh the UI
        renderComponentTree();
        updateLivePreview();
    }
}

function removeComponentById(components, id) {
    return components.filter(component => {
        if (component.id === id) {
            return false; // Remove this component
        }
        
        // If this component has children, recursively check them
        if (component.children && component.children.length > 0) {
            component.children = removeComponentById(component.children, id);
        }
        
        return true; // Keep this component
    });
}

function renderPropertiesPanel() {
    const panel = document.getElementById('propertiesPanel');
    
    if (!selectedComponent) {
        panel.innerHTML = '<p class="text-gray-500 text-center">Select a component to edit properties</p>';
        return;
    }
    
    const component = findComponentById(templateData, selectedComponent);
    if (!component) return;
    
    const isInteractive = component.tag.startsWith('I');
    
    let html = `
        <div class="space-y-4">
            <h3 class="font-medium text-gray-900">${component.tag} Properties</h3>
            
            <!-- Tag (read-only) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tag</label>
                <input type="text" value="${component.tag}" readonly class="w-full p-2 border rounded bg-gray-100">
            </div>
    `;
    
    // Common properties
    if (component.class !== undefined) {
        html += `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">CSS Classes</label>
                <input type="text" value="${component.class || ''}" 
                       onchange="updateComponentProperty('class', this.value)"
                       class="w-full p-2 border rounded">
            </div>
        `;
    }
    
    if (component.value !== undefined) {
        html += `
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                <input type="text" value="${component.value || ''}" 
                       onchange="updateComponentProperty('value', this.value)"
                       class="w-full p-2 border rounded">
            </div>
        `;
    }
    
    // Interactive component properties
    if (isInteractive) {
        if (component.type !== undefined) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select onchange="updateComponentProperty('type', this.value)" class="w-full p-2 border rounded">
                        <option value="Editable" ${component.type === 'Editable' ? 'selected' : ''}>Editable</option>
                        <option value="display" ${component.type === 'display' ? 'selected' : ''}>Display</option>
                    </select>
                </div>
            `;
        }
        
        if (component.title !== undefined) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" value="${component.title || ''}" 
                           onchange="updateComponentProperty('title', this.value)"
                           class="w-full p-2 border rounded">
                </div>
            `;
        }
        
        if (component.var !== undefined) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Variable</label>
                    <input type="text" value="${component.var || ''}" 
                           onchange="updateComponentProperty('var', this.value)"
                           class="w-full p-2 border rounded">
                </div>
            `;
        }
        
        if (component.choices) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Choices</label>
                    <textarea onchange="updateComponentProperty('choices', this.value.split(',').map(s => s.trim()))"
                              class="w-full p-2 border rounded">${component.choices.join(', ')}</textarea>
                </div>
            `;
        }
        
        if (component.options) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Options</label>
                    <textarea onchange="updateComponentProperty('options', this.value.split(',').map(s => s.trim()))"
                              class="w-full p-2 border rounded">${component.options.join(', ')}</textarea>
                </div>
            `;
        }
        
        if (component.variant) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Variant</label>
                    <select onchange="updateComponentProperty('variant', this.value)" class="w-full p-2 border rounded">
                        <option value="default" ${component.variant === 'default' ? 'selected' : ''}>Default</option>
                        <option value="destructive" ${component.variant === 'destructive' ? 'selected' : ''}>Destructive</option>
                        <option value="outline" ${component.variant === 'outline' ? 'selected' : ''}>Outline</option>
                        <option value="secondary" ${component.variant === 'secondary' ? 'selected' : ''}>Secondary</option>
                    </select>
                </div>
            `;
        }
        
        if (component.size) {
            html += `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
                    <select onchange="updateComponentProperty('size', this.value)" class="w-full p-2 border rounded">
                        <option value="default" ${component.size === 'default' ? 'selected' : ''}>Default</option>
                        <option value="sm" ${component.size === 'sm' ? 'selected' : ''}>Small</option>
                        <option value="lg" ${component.size === 'lg' ? 'selected' : ''}>Large</option>
                        <option value="icon" ${component.size === 'icon' ? 'selected' : ''}>Icon</option>
                    </select>
                </div>
            `;
        }
    }
    
    // Add child component button
    if (component.tag === 'div' || component.tag.startsWith('I')) {
        html += `
            <div class="pt-4 border-t">
                <label class="block text-sm font-medium text-gray-700 mb-2">Add Child Component</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="addComponentToParent('${component.id}', 'div')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Container</button>
                    <button onclick="addComponentToParent('${component.id}', 'p')" class="text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">Text</button>
                    <button onclick="addComponentToParent('${component.id}', 'Itext')" class="text-xs px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600">Input</button>
                    <button onclick="addComponentToParent('${component.id}', 'Ibutton')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Button</button>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    panel.innerHTML = html;
}

function updateComponentProperty(property, value) {
    if (!selectedComponent) return;
    
    const component = findComponentById(templateData, selectedComponent);
    if (component) {
        component[property] = value;
        renderComponentTree();
        updateLivePreview();
    }
}

function updateLivePreview() {
    const preview = document.getElementById('livePreview');
    try {
        const html = generateHTML(templateData, globalVars);
        preview.innerHTML = html;
    } catch (error) {
        preview.innerHTML = `<div class="text-red-500 text-sm">Error: ${error.message}</div>`;
    }
}

function generateHTML(components, vars = {}) {
    return components.map(component => renderComponentToHTML(component, vars)).join('');
}

function renderComponentToHTML(component, vars = {}) {
    const tag = component.tag;
    const classes = component.class || '';
    const value = resolveValue(component.value, component.var, vars);
    
    if (tag.startsWith('I')) {
        return renderInteractiveComponent(component, vars);
    }
    
    // Regular HTML elements
    if (component.children && component.children.length > 0) {
        const childrenHTML = component.children.map(child => renderComponentToHTML(child, vars)).join('');
        return `<${tag} class="${classes}">${childrenHTML}</${tag}>`;
    } else {
        return `<${tag} class="${classes}">${value}</${tag}>`;
    }
}

function renderInteractiveComponent(component, vars = {}) {
    const tag = component.tag;
    const classes = component.class || '';
    const title = component.title || '';
    const value = resolveValue(component.value, component.var, vars);
    const type = component.type || 'Editable';
    
    if (type === 'display') {
        return `<div class="${classes}"><strong>${title}:</strong> ${value}</div>`;
    }
    
    switch (tag) {
        case 'Itext':
            return `<div class="mb-2"><label class="block text-sm font-medium mb-1">${title}</label><input type="text" value="${value}" class="${classes}" readonly></div>`;
        case 'IBool':
            return `<div class="mb-2"><label class="flex items-center"><input type="checkbox" ${value ? 'checked' : ''} class="${classes}" readonly> <span class="ml-2">${title}</span></label></div>`;
        case 'IChoice':
            const choices = component.choices || [];
            const options = choices.map(choice => `<option value="${choice}" ${choice === value ? 'selected' : ''}>${choice}</option>`).join('');
            return `<div class="mb-2"><label class="block text-sm font-medium mb-1">${title}</label><select class="${classes}" disabled>${options}</select></div>`;
        case 'IToggle':
            const toggleOptions = component.options || [];
            const toggles = toggleOptions.map(option => `<button class="px-3 py-1 border rounded ${option === value ? 'bg-blue-500 text-white' : 'bg-white'}">${option}</button>`).join('');
            return `<div class="mb-2"><label class="block text-sm font-medium mb-1">${title}</label><div class="${classes}">${toggles}</div></div>`;
        case 'Imultiline':
            return `<div class="mb-2"><label class="block text-sm font-medium mb-1">${title}</label><textarea class="${classes}" readonly>${value}</textarea></div>`;
        case 'Ibutton':
        case 'I_V_Button':
            return `<div class="mb-2"><button class="${classes}" disabled>${title}</button></div>`;
        default:
            return `<div class="${classes}">${title}: ${value}</div>`;
    }
}

function resolveValue(value, varName, vars) {
    if (varName && vars[varName] !== undefined) {
        return vars[varName];
    }
    return value || '';
}

function toggleJsonView() {
    const visualEditor = document.getElementById('visualEditor');
    const jsonEditor = document.getElementById('jsonEditor');
    
    if (visualEditor.classList.contains('hidden')) {
        // Switch to visual editor
        visualEditor.classList.remove('hidden');
        jsonEditor.classList.add('hidden');
        // Update JSON from visual editor
        document.getElementById('templateJson').value = JSON.stringify(templateData, null, 2);
    } else {
        // Switch to JSON editor
        visualEditor.classList.add('hidden');
        jsonEditor.classList.remove('hidden');
        // Update visual editor from JSON
        try {
            const jsonData = document.getElementById('templateJson').value;
            templateData = JSON.parse(jsonData);
            addComponentIds(templateData);
            renderComponentTree();
            updateLivePreview();
        } catch (error) {
            alert('Invalid JSON: ' + error.message);
        }
    }
}

function updatePreview() {
    const templateJson = document.getElementById('templateJson').value;
    const globalVarsJson = document.getElementById('globalVars').value;
    
    try {
        const template = JSON.parse(templateJson);
        const vars = JSON.parse(globalVarsJson || '{}');
        
        // Update preview with formatted JSON
        document.getElementById('preview').innerHTML = `
            <pre class="text-xs overflow-auto">${JSON.stringify(template, null, 2)}</pre>
            <div class="mt-4 pt-4 border-t">
                <h4 class="font-medium mb-2">Global Variables:</h4>
                <pre class="text-xs overflow-auto">${JSON.stringify(vars, null, 2)}</pre>
            </div>
        `;
    } catch (error) {
        document.getElementById('preview').innerHTML = `
            <div class="text-red-500 text-sm">
                <strong>JSON Error:</strong> ${error.message}
            </div>
        `;
    }
}

function validateJson() {
    const templateJson = document.getElementById('templateJson').value;
    const globalVarsJson = document.getElementById('globalVars').value;
    
    try {
        const template = JSON.parse(templateJson);
        const vars = JSON.parse(globalVarsJson || '{}');
        
        // Basic validation
        if (!Array.isArray(template)) {
            alert('Template must be an array of components');
            return;
        }
        
        // Validate each component
        for (let i = 0; i < template.length; i++) {
            const component = template[i];
            if (!component.tag) {
                alert(`Component ${i}: Missing 'tag' property`);
                return;
            }
        }
        
        alert('✅ JSON is valid!');
    } catch (error) {
        alert('❌ Invalid JSON: ' + error.message);
    }
}

function formatJson() {
    const templateJson = document.getElementById('templateJson').value;
    const globalVarsJson = document.getElementById('globalVars').value;
    
    try {
        const template = JSON.parse(templateJson);
        const vars = JSON.parse(globalVarsJson || '{}');
        
        document.getElementById('templateJson').value = JSON.stringify(template, null, 2);
        document.getElementById('globalVars').value = JSON.stringify(vars, null, 2);
        
        updatePreview();
    } catch (error) {
        alert('Cannot format invalid JSON: ' + error.message);
    }
}

// Component drag and drop functionality
function setupComponentDragAndDrop() {
    const componentTree = document.getElementById('componentTree');
    let draggedElement = null;
    let dropIndicator = null;
    
    // Create drop indicator element
    function createDropIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';
        indicator.style.cssText = `
            height: 2px;
            background: #3b82f6;
            margin: 4px 0;
            border-radius: 1px;
            opacity: 0;
            transition: opacity 0.2s ease;
        `;
        return indicator;
    }
    
    // Make components draggable
    componentTree.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('draggable-component')) {
            draggedElement = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.componentId);
            e.target.style.opacity = '0.5';
            e.target.classList.add('dragging');
            
            // Create drop indicator
            dropIndicator = createDropIndicator();
            componentTree.appendChild(dropIndicator);
        }
    });
    
    componentTree.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('draggable-component')) {
            e.target.style.opacity = '1';
            e.target.classList.remove('dragging');
            
            // Remove drop indicator
            if (dropIndicator) {
                dropIndicator.remove();
                dropIndicator = null;
            }
            
            // Remove all drag-over classes
            componentTree.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            draggedElement = null;
        }
    });
    
    componentTree.addEventListener('dragover', function(e) {
        e.preventDefault();
        
        if (!draggedElement || !dropIndicator) return;
        
        const afterElement = getDragAfterElement(componentTree, e.clientY);
        
        // Remove all drag-over classes
        componentTree.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
        
        // Add drag-over class to the target element
        if (afterElement) {
            afterElement.classList.add('drag-over');
        }
        
        // Position the drop indicator
        if (afterElement) {
            componentTree.insertBefore(dropIndicator, afterElement);
        } else {
            componentTree.appendChild(dropIndicator);
        }
        
        // Show the indicator
        dropIndicator.style.opacity = '1';
    });
    
    componentTree.addEventListener('dragleave', function(e) {
        // Only remove drag-over if we're leaving the entire container
        if (!componentTree.contains(e.relatedTarget)) {
            componentTree.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            if (dropIndicator) {
                dropIndicator.style.opacity = '0';
            }
        }
    });
    
    componentTree.addEventListener('drop', function(e) {
        e.preventDefault();
        
        if (!draggedElement) return;
        
        const componentId = e.dataTransfer.getData('text/plain');
        const afterElement = getDragAfterElement(componentTree, e.clientY);
        
        // Remove all drag-over classes
        componentTree.querySelectorAll('.drag-over').forEach(el => {
            el.classList.remove('drag-over');
        });
        
        // Reorder components in data
        reorderComponents(componentId, afterElement);
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.draggable-component:not(.dragging)')];
    
    if (draggableElements.length === 0) return null;
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function reorderComponents(componentId, afterElement) {
    // Find the component in templateData
    const fromIndex = templateData.findIndex(comp => comp.id === componentId);
    if (fromIndex === -1) return;
    
    const draggedComponent = templateData[fromIndex];
    
    // Remove from original position
    templateData.splice(fromIndex, 1);
    
    // Find new position
    let newIndex = templateData.length; // Default to end
    if (afterElement) {
        const afterComponentId = afterElement.dataset.componentId;
        newIndex = templateData.findIndex(comp => comp.id === afterComponentId);
    }
    
    // Insert at new position
    templateData.splice(newIndex, 0, draggedComponent);
    
    // Update selected component if needed
    if (selectedComponent === componentId) {
        // Component stays selected
    }
    
    // Re-render and update
    renderComponentTree();
    updateLivePreview();
    
    // Auto-save after reordering
    autoSave();
}

async function saveTemplate() {
    try {
        // Get current template data
        const currentTemplateData = templateData;
        const globalVarsData = globalVars;
        
        const response = await fetch(`/cardgen/save/{{ template.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(currentTemplateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Template saved successfully!');
        } else {
            alert('Error saving template: ' + result.error);
        }
    } catch (error) {
        alert('Error saving template: ' + error.message);
    }
}

// Auto-save function for drag and drop operations
async function autoSave() {
    try {
        const response = await fetch(`/cardgen/save/{{ template.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(templateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Auto-saved template after reordering');
        } else {
            console.error('Auto-save failed:', result.error);
        }
    } catch (error) {
        console.error('Auto-save error:', error);
    }
}

// Tab switching functionality
function switchTab(tabName) {
    // Remove active classes from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-blue-500', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Hide all tab contents
    document.querySelectorAll('[id^="tab-content-"]').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected tab and mark as active
    const activeTab = document.getElementById(`tab-${tabName}`);
    const activeContent = document.getElementById(`tab-content-${tabName}`);
    
    if (activeTab && activeContent) {
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-blue-500', 'text-blue-600');
        activeContent.classList.remove('hidden');
    }
}

// AI Chat functionality
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Clear input
    input.value = '';
    
    // Add user message to chat
    addMessageToChat(message, 'user');
    
    // Disable send button while processing
    const sendButton = document.getElementById('sendChatButton');
    sendButton.disabled = true;
    sendButton.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    `;
    
    // Process the message and get GPT response
    processUserMessage(message);
}

function addMessageToChat(message, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    if (sender === 'user') {
        messageDiv.className = 'flex items-start space-x-3 justify-end';
        messageDiv.innerHTML = `
            <div class="bg-blue-500 text-white rounded-lg p-3 max-w-xs">
                <p class="text-sm">${escapeHtml(message)}</p>
            </div>
            <div class="flex-shrink-0 w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
        `;
    } else {
        messageDiv.className = 'flex items-start space-x-3';
        messageDiv.innerHTML = `
            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
            </div>
            <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                <p class="text-sm text-gray-700">${escapeHtml(message)}</p>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// AI Chat API Integration
async function processUserMessage(message) {
    console.log('Processing user message:', message);
    console.log('Current template data:', templateData);
    
    try {
        const response = await fetch(`/cardgen/ai-chat/{{ template.id }}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                message: message
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            handleGPTResponse(result.response);
        } else {
            handleGPTResponse(`Error: ${result.error}`);
        }
    } catch (error) {
        console.error('Error calling AI chat API:', error);
        handleGPTResponse('Sorry, I encountered an error while processing your request. Please try again.');
    }
}


function handleGPTResponse(response) {
    console.log('GPT Response received:', response);
    
    // Check if response contains "@JSON" or "@CODE"
    const trimmedResponse = response.trim();
    const isCodeResponse = trimmedResponse.startsWith('@CODE') || trimmedResponse.includes('@JSON');
    
    if (isCodeResponse) {
        let jsonString = '';
        
        // Handle @JSON format (with markdown code blocks)
        if (trimmedResponse.includes('@JSON')) {
            // Look for JSON in markdown code blocks
            const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch && jsonMatch[1]) {
                jsonString = jsonMatch[1].trim();
            }
        }
        
        // Handle @CODE format (simple JSON after @CODE line)
        else if (trimmedResponse.startsWith('@CODE')) {
            const lines = trimmedResponse.split('\n');
            const codeLineIndex = lines.findIndex(line => line.trim() === '@CODE');
            
            if (codeLineIndex !== -1 && codeLineIndex + 1 < lines.length) {
                const jsonLines = lines.slice(codeLineIndex + 1);
                jsonString = jsonLines.join('\n').trim();
            }
        }
        
        // Try to parse and apply the JSON
        if (jsonString) {
            try {
                // Parse the JSON to validate it
                const jsonData = JSON.parse(jsonString);
                
                // Wrap in array and update template
                templateData = Array.isArray(jsonData) ? jsonData : [jsonData];
                
                // Re-render the component tree and preview
                renderComponentTree();
                updateLivePreview();
                
                // Auto-save the changes
                autoSave();
                
                // Extract the descriptive text (everything after the code block)
                let descriptiveText = '';
                if (trimmedResponse.includes('@JSON')) {
                    const afterCodeBlock = response.split('```').pop();
                    if (afterCodeBlock && afterCodeBlock.trim()) {
                        descriptiveText = afterCodeBlock.trim();
                    }
                } else {
                    // For @CODE, show "Done." 
                    descriptiveText = 'Done.';
                }
                
                // Show the descriptive text in chat
                addMessageToChat(descriptiveText, 'ai');
                
                console.log('Template updated with AI-generated code');
                
            } catch (error) {
                console.error('Invalid JSON from AI:', error);
                console.error('JSON string that failed:', jsonString);
                // If JSON is invalid, show the full response
                addMessageToChat(response, 'ai');
            }
        } else {
            // If @JSON/@CODE but no JSON found, show full response
            addMessageToChat(response, 'ai');
        }
    } else {
        // Regular response - show the full response
        addMessageToChat(response, 'ai');
    }
    
    // Re-enable send button
    const sendButton = document.getElementById('sendChatButton');
    sendButton.disabled = false;
    sendButton.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
    `;
}
</script>

<style>
.component-item {
    @apply p-4 border border-gray-200 rounded cursor-move hover:bg-gray-50 transition-colors text-sm flex items-center space-x-3;
}

.component-node {
    @apply transition-colors cursor-pointer;
}

.component-node:hover {
    @apply shadow-sm;
}

.drag-over {
    @apply bg-blue-50 border-blue-300;
}

/* Custom scrollbar for panels */
.overflow-y-auto::-webkit-scrollbar {
    width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Resize handles */
.cursor-col-resize {
    cursor: col-resize;
}

.cursor-col-resize:hover {
    background-color: #9ca3af;
}

/* Component palette popup */
#componentPalette {
    backdrop-filter: blur(4px);
}

#componentPalette .bg-white {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

/* Panel shadows */
.bg-white:not(#componentPalette .bg-white) {
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

/* Popup animation */
#componentPalette {
    transition: opacity 0.2s ease-in-out;
}

#componentPalette.hidden {
    opacity: 0;
    pointer-events: none;
}

#componentPalette:not(.hidden) {
    opacity: 1;
    pointer-events: auto;
}

/* Drag and Drop Styles for Card Components */
.draggable-component {
    transition: all 0.2s ease;
}

.draggable-component:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.draggable-component.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
    z-index: 1000;
}

.draggable-component .drag-handle {
    transition: color 0.2s ease;
}

.draggable-component .drag-handle:hover {
    color: #6b7280 !important;
}

.draggable-component .drag-handle svg {
    transition: all 0.2s ease;
}

.draggable-component .drag-handle:hover svg {
    transform: scale(1.1);
}

/* Visual feedback for drag operations */
.dragging {
    cursor: grabbing !important;
}

.draggable-component:not(.dragging) {
    cursor: grab;
}

/* Drop zone indicators */
.draggable-component.drag-over {
    border-color: #3b82f6;
    background-color: #eff6ff;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Drop indicator line */
.drop-indicator {
    height: 2px;
    background: #3b82f6;
    margin: 4px 0;
    border-radius: 1px;
    opacity: 0;
    transition: opacity 0.2s ease;
    box-shadow: 0 0 4px rgba(59, 130, 246, 0.3);
}

/* Component styling improvements */
.draggable-component {
    border-left: 3px solid transparent;
    transition: border-color 0.2s ease;
}

.draggable-component:hover {
    border-left-color: #8b5cf6;
}

/* Selection state improvements */
.draggable-component.bg-blue-50 {
    border-left-color: #3b82f6;
    background-color: #eff6ff;
}

/* Smooth animations for reordering */
#componentTree {
    transition: all 0.3s ease;
}

/* Tree View Improvements */
.tree-line {
    position: relative;
}

.tree-line::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 1px;
    height: 100%;
    background: #d1d5db;
}

.expand-btn {
    transition: all 0.2s ease;
}

.expand-btn:hover {
    background-color: #f3f4f6;
    border-radius: 2px;
}

.children-container {
    position: relative;
}

.children-container::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #e5e7eb;
}

/* Compact view styles */
.compact-view .component-node {
    font-size: 0.75rem;
}

.compact-view .component-node .text-xs {
    font-size: 0.65rem;
}

.compact-view .expand-btn svg {
    width: 0.75rem;
    height: 0.75rem;
}

.compact-view .drag-handle svg {
    width: 8px;
    height: 8px;
}

/* Tree container scrolling */
#treeContainer {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f7fafc;
}

#treeContainer::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

#treeContainer::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 4px;
}

#treeContainer::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

#treeContainer::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

/* Tree stats and controls */
#treeStats {
    font-weight: 500;
    color: #4a5568;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .draggable-component .drag-handle {
        padding: 0.25rem;
    }
    
    .draggable-component .drag-handle svg {
        width: 8px;
        height: 8px;
    }
    
    .component-node {
        min-width: 150px !important;
        padding: 0.25rem !important;
    }
    
    .expand-btn svg {
        width: 0.75rem;
        height: 0.75rem;
    }
}

/* Tree view toggle button */
.tree-toggle-btn {
    transition: all 0.2s ease;
}

.tree-toggle-btn:hover {
    background-color: #f3f4f6;
    transform: scale(1.05);
}

/* Tab styles */
.tab-button {
    transition: all 0.2s ease;
    position: relative;
}

.tab-button:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

.tab-button:focus {
    outline: none;
    background-color: rgba(59, 130, 246, 0.1);
}

/* Chat message animations */
#chatMessages {
    scroll-behavior: smooth;
}

.chat-message {
    animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Chat input focus styles */
#chatInput:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Send button loading animation */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* Chat scrollbar styling */
#chatMessages::-webkit-scrollbar {
    width: 6px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Message bubble styles */
.message-bubble {
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* AI message styling */
.ai-message {
    border-left: 3px solid #3b82f6;
}

/* User message styling */
.user-message {
    border-right: 3px solid #3b82f6;
}
</style>
{% endblock %}
